# .github/workflows/ios-simulator.yml
name: iOS Simulator Build

on:
  workflow_dispatch:

jobs:
  build-simulator:
    runs-on: macos-latest
    timeout-minutes: 45
    
    steps:
    - name: í ½í³¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: í ½í°¦ å®‰è£… Flutter
      run: |
        git clone https://github.com/flutter/flutter.git -b stable --depth 1
        echo "$GITHUB_WORKSPACE/flutter/bin" >> $GITHUB_PATH
    
    - name: í ½í´§ é…ç½® Flutter
      run: |
        flutter config --no-analytics
        flutter --version
        flutter doctor -v
    
    - name: í ½í³¦ è·å–ä¾èµ–
      run: flutter pub get
    
    - name: í ¼í½ æ„å»º iOS æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬
      run: |
        echo "í ½í´¨ æ„å»ºæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬..."
        flutter build ios --simulator --debug
        
        echo "í ½í´ æ£€æŸ¥æ„å»ºç»“æœ..."
        ls -la build/ios/iphonesimulator/
    
    - name: í ½í³¦ åˆ›å»ºæ¨¡æ‹Ÿå™¨ APP åŒ…
      run: |
        echo "í ½í³¦ å‡†å¤‡æ¨¡æ‹Ÿå™¨åº”ç”¨åŒ…..."
        
        if [ -d "build/ios/iphonesimulator/Runner.app" ]; then
          echo "âœ… æ‰¾åˆ°æ¨¡æ‹Ÿå™¨åº”ç”¨"
          
          # åˆ›å»ºç”¨äº Appetize çš„ ZIP åŒ…
          mkdir -p simulator-build
          cp -r build/ios/iphonesimulator/Runner.app simulator-build/
          
          # æ‰“åŒ…ä¸º ZIP (Appetize æ ¼å¼)
          cd simulator-build
          zip -r ../aibfarm-simulator.zip Runner.app
          cd ..
          
          echo "í ½í³± æ¨¡æ‹Ÿå™¨åŒ…ä¿¡æ¯ï¼š"
          ls -la aibfarm-simulator.zip
          du -sh aibfarm-simulator.zip
          
          # éªŒè¯åº”ç”¨æ¶æ„
          echo "í ½í´ åº”ç”¨æ¶æ„ï¼š"
          file simulator-build/Runner.app/Runner
          
        else
          echo "âŒ æ¨¡æ‹Ÿå™¨åº”ç”¨æ„å»ºå¤±è´¥"
          echo "í ½í³‚ iphonesimulator ç›®å½•å†…å®¹ï¼š"
          find build/ios/iphonesimulator/ -name "*.app" 2>/dev/null || echo "æœªæ‰¾åˆ° .app æ–‡ä»¶"
          exit 1
        fi
    
    - name: í ½í³± ä¸Šä¼ æ¨¡æ‹Ÿå™¨åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: aibfarm-simulator-${{ github.run_number }}
        path: "aibfarm-simulator.zip"
        retention-days: 30
    
    - name: í ½í³Š æ„å»ºæŠ¥å‘Š
      run: |
        echo "## í ½í³± iOS æ¨¡æ‹Ÿå™¨æ„å»ºæŠ¥å‘Š"
        echo ""
        if [ -f "aibfarm-simulator.zip" ]; then
          echo "### âœ… æ¨¡æ‹Ÿå™¨æ„å»ºæˆåŠŸ"
          echo "- **ç±»å‹**: iOS æ¨¡æ‹Ÿå™¨åº”ç”¨"
          echo "- **æ–‡ä»¶**: aibfarm-simulator.zip"
          echo "- **å¤§å°**: $(du -h aibfarm-simulator.zip | cut -f1)"
          echo "- **æ¶æ„**: x86_64 (æ¨¡æ‹Ÿå™¨)"
          echo "- **ç”¨é€”**: Appetize.io åœ¨çº¿æµ‹è¯•"
          echo ""
          echo "### í ½í³¥ ä½¿ç”¨æ–¹æ³•"
          echo "1. ä¸‹è½½ 'aibfarm-simulator-${{ github.run_number }}'"
          echo "2. è§£å‹å¾—åˆ° aibfarm-simulator.zip"
          echo "3. ä¸Šä¼ åˆ° appetize.io è¿›è¡Œåœ¨çº¿æµ‹è¯•"
          echo "4. é€‰æ‹© iOS è®¾å¤‡å’Œæ¨¡æ‹Ÿå™¨é€‰é¡¹"
        else
          echo "### âŒ æ¨¡æ‹Ÿå™¨æ„å»ºå¤±è´¥"
          echo "è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦æƒ…"
        fi
